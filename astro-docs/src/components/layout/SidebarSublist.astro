---
/*
 * This is a modified version of the SidebarSublist component from Starlight with support for icons.
 * https://github.com/withastro/starlight/blob/46524ac/packages/starlight/components/SidebarSublist.astro -->
 */
import { Badge, Icon } from '@astrojs/starlight/components';

export interface SidebarLink {
  type: 'link';
  label: string;
  href: string;
  isCurrent: boolean;
  badge: any;
  attrs: any;
}

export interface SidebarGroup {
  type: 'group';
  label: string;
  entries: (SidebarLink | SidebarGroup)[];
  collapsed: boolean;
  badge: any;
  attrs?: any;
}

export type SidebarEntry = SidebarLink | SidebarGroup;

interface Props {
  sublist: SidebarEntry[];

  nested?: boolean;
}

const { sublist, nested } = Astro.props;

// Copied from https://github.com/withastro/starlight/blob/46524ac/packages/starlight/utils/navigation.ts#L447
function flattenSidebar(entries: SidebarEntry[]): SidebarEntry[] {
  return entries.reduce<SidebarEntry[]>((acc, entry) => {
    if (entry.type === 'group') acc.push(...flattenSidebar(entry.entries));
    else acc.push(entry);
    return acc;
  }, []);
}

function getIconPath(iconName: string | undefined): string | null {
  if (!iconName) return null;
  return `/docs/images/icons/${iconName}.svg`;
}
---

<ul class:list={{ 'top-level': !nested }}>
  {
    sublist.map((entry) => {
      const icon = getIconPath(entry.attrs?.['data-icon']);
      return (
        <li class={icon ? 'border-none p-0' : ''}>
          {entry.type === 'link' ? (
            <a
              href={entry.href}
              aria-current={entry.isCurrent && 'page'}
              class:list={[{ large: !nested }, entry.attrs?.class]}
              {...entry.attrs}
            >
              {icon && (
                <img
                  aria-hidden="true"
                  src={icon}
                  alt=""
                  class="sidebar-icon h-4 w-4 dark:invert"
                />
              )}
              <span>{entry.label}</span>
              {entry.badge && (
                <Badge
                  variant={entry.badge.variant}
                  class={entry.badge.class}
                  text={entry.badge.text}
                />
              )}
            </a>
          ) : (
            <details
              open={
                flattenSidebar(entry.entries).some((i: any) => i.isCurrent) ||
                !entry.collapsed
              }
            >
              <summary class={icon ? 'py-2 pl-0' : ''}>
                <div class="group-label">
                  {icon && (
                    <img
                      aria-hidden="true"
                      src={icon}
                      alt=""
                      class="sidebar-icon h-4 w-4 dark:invert"
                    />
                  )}
                  <span class="large">{entry.label}</span>
                  {entry.badge && (
                    <Badge
                      variant={entry.badge.variant}
                      class={entry.badge.class}
                      text={entry.badge.text}
                    />
                  )}
                </div>
                <Icon name="right-caret" class="caret" size="1.25rem" />
              </summary>
              <Astro.self sublist={entry.entries} nested />
            </details>
          )}
        </li>
      );
    })
  }
</ul>

<!-- Copied from https://github.com/withastro/starlight/blob/46524ac/packages/starlight/components/SidebarSublist.astro -->
<style>
  @layer starlight.core {
    ul {
      --sl-sidebar-item-padding-inline: 0.375rem;
      list-style: none;
      padding: 0;
    }

    li {
      overflow-wrap: anywhere;
    }

    ul ul li {
      margin-inline-start: var(--sl-sidebar-item-padding-inline);
      border-inline-start: 1px solid var(--sl-color-hairline-light);
      padding-inline-start: var(--sl-sidebar-item-padding-inline);
    }

    .large {
      font-size: var(--sl-text-lg);
      font-weight: 600;
      color: var(--sl-color-white);
    }

    a.large {
      font-size: inherit;
      font-weight: inherit;
      color: inherit;
    }

    .top-level {
      padding-top: 0.75rem;
    }

    .top-level > li + li {
      margin-top: 0.5rem;
    }

    summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.2em var(--sl-sidebar-item-padding-inline);
      line-height: 1.4;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      color: var(--sl-color-white);
      border-radius: 0.25rem;
    }

    summary:hover {
      background-color: color-mix(
        in srgb,
        var(--sl-color-gray-5) 40%,
        transparent
      );
    }

    summary::marker,
    summary::-webkit-details-marker {
      display: none;
    }

    .caret {
      transition:
        transform 0.2s ease-in-out,
        color 0.15s ease;
      flex-shrink: 0;
      color: var(--sl-color-gray-4);
    }

    .caret:hover,
    summary:hover .caret {
      color: var(--sl-color-gray-2);
    }

    :global([dir='rtl']) .caret {
      transform: rotateZ(180deg);
    }

    [open] > summary .caret {
      transform: rotateZ(90deg);
      color: var(--sl-color-text-accent);
    }

    [open] > summary {
      color: var(--sl-color-text-accent);
    }

    a {
      display: block;
      border-radius: 0.25rem;
      text-decoration: none;
      color: var(--sl-color-gray-2);
      padding: 0.2em var(--sl-sidebar-item-padding-inline);
      line-height: 1.4;
    }

    a:hover,
    a:focus {
      color: var(--sl-color-white);
    }

    [aria-current='page'],
    [aria-current='page']:hover,
    [aria-current='page']:focus {
      font-weight: 600;
      color: var(--sl-color-text-invert);
      background-color: var(--sl-color-text-accent);
    }

    a > *:not(:last-child),
    .group-label > *:not(:last-child) {
      margin-inline-end: 0.25em;
    }

    /*
     * Deep nesting adjustments (3+ levels).
     * Uses :is() to target any li that is at least 3 levels deep,
     * then tightens spacing progressively via custom properties.
     */
    ul ul ul {
      --_nest-indent: 0.25rem;
      --_nest-link-block: 0.15em;
    }

    ul ul ul ul {
      --_nest-indent: 0.2rem;
    }

    ul ul ul li {
      margin-inline-start: var(--_nest-indent);
      padding-inline-start: var(--_nest-indent);
    }

    ul ul ul a {
      padding-block: var(--_nest-link-block);
    }

    /* Smooth expand/collapse â€” progressive enhancement (Chrome 129+, Firefox 131+, Safari 17.5+).
       Gated behind .sidebar-animate (added by JS after first paint) to prevent
       already-open groups from animating on page load. */
    details {
      interpolate-size: allow-keywords;
    }

    :global(.sidebar-animate) details > ul {
      overflow: hidden;
      height: 0;
      opacity: 0;
      transition:
        height 0.2s ease,
        opacity 0.15s ease;
    }

    :global(.sidebar-animate) details[open] > ul {
      height: auto;
      opacity: 1;
    }

    @starting-style {
      :global(.sidebar-animate) details[open] > ul {
        height: 0;
        opacity: 0;
      }
    }

    @media (min-width: 50rem) {
      .top-level > li + li {
        margin-top: 0.375rem;
      }

      .large {
        font-size: var(--sl-text-base);
      }

      a {
        font-size: var(--sl-text-sm);
      }
    }
  }
</style>
