---
import MobileMenuFooter from '@astrojs/starlight/components/MobileMenuFooter.astro'
import SidebarPersister from '@astrojs/starlight/components/SidebarPersister.astro'
import SidebarSublist from './SidebarSublist.astro'
import TabbedSidebar from './sidebar-tabs/TabbedSidebar.astro'
import SidebarTab from './sidebar-tabs/SidebarTab.astro'
import SidebarTabPanel from './sidebar-tabs/SidebarTabPanel.astro'
import type { SidebarEntry } from './SidebarSublist.astro'
import { sidebarTabs } from '../../../sidebar.mts'

const { sidebar } = Astro.locals.starlightRoute

// Check if any entry in a tree has isCurrent
function hasCurrentPage(entries: SidebarEntry[]): boolean {
  return entries.some((entry) => {
    if (entry.type === 'link') return entry.isCurrent
    return hasCurrentPage(entry.entries)
  })
}

// For each tab, resolve its groups from the sidebar using the tab's group labels
const tabs = sidebarTabs.map((config) => {
  const groupLabels = config.groups.map((g) =>
    typeof g === 'string' ? g : g.label
  )
  const groups = sidebar.filter(
    (entry: SidebarEntry) => entry.type === 'group' && groupLabels.includes(entry.label)
  )
  // Single-group tabs: unwrap the top-level group to avoid redundant heading
  const isSingleGroup = groups.length === 1 && groups[0].type === 'group'
  const entries: SidebarEntry[] = isSingleGroup ? (groups[0] as any).entries : groups
  const active = hasCurrentPage(groups)
  return { ...config, entries, active }
})

// Exactly one tab should be active; if none matched, leave it for the client to decide
const anyActive = tabs.some((t) => t.active)
---

<div class="sidebar-wrapper" data-testid="sidebar-wrapper">
    <SidebarPersister>
        <TabbedSidebar>
            {tabs.map((tab) => (
                <SidebarTab
                    slot="tabs"
                    id={tab.id}
                    icon={tab.icon}
                    label={tab.label}
                    active={anyActive ? tab.active : false}
                />
            ))}
            {tabs.map((tab) => (
                <SidebarTabPanel
                    slot="panels"
                    id={`${tab.id}-panel`}
                    tabId={tab.id}
                    active={anyActive ? tab.active : false}
                >
                    <SidebarSublist sublist={tab.entries} />
                </SidebarTabPanel>
            ))}
        </TabbedSidebar>
    </SidebarPersister>
    <div class="md:sl-hidden">
        <MobileMenuFooter/>
    </div>
</div>

<script>
  // Enable sidebar expand/collapse animations after first paint so that
  // groups that are already open on page load don't animate from closed.
  requestAnimationFrame(() => {
    document.querySelector('.sidebar-wrapper')?.classList.add('sidebar-animate');
  });
</script>

<style>
    .sidebar-wrapper :global(a) {
        color: var(--sl-color-gray-3);
    }

    .sidebar-wrapper :global(a[aria-current=page]) {
        background-color: transparent;
        color: var(--sl-color-text-accent);
        font-weight: var(--font-weight-semibold);
    }

    .sidebar-wrapper :global(ul ul .large) {
        color: var(--sl-color-gray-3);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-medium);
    }

    .sidebar-wrapper :global(details summary .group-label) {
        font-size: var(--text-base);
        font-weight: var(--font-weight-medium);
    }

    .sidebar-wrapper :global(ul ul summary) {
        font-weight: var(--font-weight-medium);
    }

    .sidebar-wrapper :global(details[open] summary .group-label) {
        color: var(--sl-color-text-accent);
    }
</style>
