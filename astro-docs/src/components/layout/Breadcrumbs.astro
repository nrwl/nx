---
import { Icon } from '@astrojs/starlight/components';
import { getCollection } from 'astro:content';

type Crumb = {
  label: string;
  href?: string;
  current: boolean;
};

function slugify(label: string): string {
  return label
    .replace(/\.NET/g, 'dotnet')
    .toLowerCase()
    .replace(/[^a-z0-9_]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

// --- Primary: Sidebar-based breadcrumbs ---
const sidebar = Astro.locals.starlightRoute.sidebar;

function findBreadcrumbPath(
  entries: typeof sidebar,
  path: Crumb[] = [],
  slugSegments: string[] = []
): Crumb[] | null {
  for (const entry of entries) {
    if (entry.type === 'link' && entry.isCurrent) {
      return [...path, { label: entry.label, href: entry.href, current: true }];
    }
    if (entry.type === 'group') {
      const currentSlugs = [...slugSegments, slugify(entry.label)];
      const groupHref = `/docs/${currentSlugs.join('/')}`;
      const result = findBreadcrumbPath(
        entry.entries,
        [
          ...path,
          { label: entry.label, href: groupHref, current: false },
        ],
        currentSlugs
      );
      if (result) return result;
    }
  }
  return null;
}

let crumbs: Crumb[] = findBreadcrumbPath(sidebar) ?? [];

// --- Fallback: URL-path-based breadcrumbs ---
if (crumbs.length === 0) {
  const { pathname } = Astro.url;
  const cleanedPath = pathname.split('?')[0];
  const allDocs = await getCollection('docs');
  const pathSegments = cleanedPath.split('/').filter(Boolean);

  function findDocByPath(path: string) {
    path = path.replace(/^docs\//, '');
    return (
      allDocs.find((d) => d.id === `${path}`) ??
      allDocs.find((d) => d.id === `${path}/index`)
    );
  }

  function createNameFromSegment(segment: string): string {
    segment = segment.split('#')[0];
    return segment
      .split('-')
      .map((s) => s.charAt(0).toUpperCase() + s.slice(1))
      .join(' ');
  }

  crumbs = pathSegments
    .map((segment, index) => {
      const docPath = pathSegments.slice(0, index + 1).join('/');
      const doc = findDocByPath(docPath);
      const label =
        doc?.data?.sidebar?.label ||
        doc?.data?.title ||
        createNameFromSegment(segment);
      // If `base` is set in config, don't include it in breadcrumbs
      if (index === 0 && import.meta.env.BASE_URL) return null;
      return {
        label,
        href: `/${docPath}`,
        current: index === pathSegments.length - 1,
      };
    })
    .filter(Boolean) as Crumb[];
}
---

<nav class="not-content flex mb-4" aria-label="Breadcrumb">
  <ol role="list" class="flex m-0 p-0 flex-wrap items-center space-x-2 text-sm">
    {
      crumbs.map((crumb, index) => (
        <li class="flex items-center">
          {index > 0 && <Icon name="right-caret" class="w-5 h-5 ml-2 mr-2" />}
          {crumb.href ? (
            <a
              href={crumb.href}
              class={`no-underline text-sm${
                crumb.current
                  ? ' text-slate-900 dark:text-slate-100 font-semibold'
                  : ' text-slate-500 dark:text-slate-400 font-medium hover:text-slate-700 dark:hover:text-slate-200'
              } transition-colors`}
              aria-current={crumb.current ? 'page' : undefined}
            >
              {crumb.label}
            </a>
          ) : (
            <span class="text-sm text-slate-500 dark:text-slate-400 font-medium">
              {crumb.label}
            </span>
          )}
        </li>
      ))
    }
  </ol>
</nav>
