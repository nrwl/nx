---
export interface Props {
  title: string;
  promptText: string;
}

const { title, promptText } = Astro.props;

const siteOrigin = Astro.site?.origin ?? 'https://nx.dev';
const pageUrl = `${siteOrigin}${Astro.url.pathname}.md`;
const finalPrompt = promptText.replace(/\{pageUrl\}/g, pageUrl);

const id = `llm-prompt-${Math.random().toString(36).slice(2, 9)}`;

// Split prompt into lines for rendering
const promptLines = finalPrompt.split('\n').filter((l) => l.length > 0);
---

<llm-copy-prompt data-content-id={id}>
  <details class="llm-prompt-card">
    <summary>
      <div class="llm-prompt-header">
        <div class="llm-prompt-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            width="20"
            height="20"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 0 0-2.455 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z"
            ></path>
          </svg>
        </div>
        <span class="llm-prompt-title">{title}</span>
        <button type="button" class="llm-copy-btn" aria-label="Copy prompt">
          <svg
            class="icon-default"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            width="16"
            height="16"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 6.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0 0 15 2.25h-1.5a2.251 2.251 0 0 0-2.15 1.586m5.8 0c.065.21.1.433.1.664v.75h-6V4.5c0-.231.035-.454.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V16.5a9 9 0 0 0-9-9Z"
            ></path>
          </svg>
          <svg
            class="icon-copied"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            width="16"
            height="16"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
            ></path>
          </svg>
          <span class="copy-label">Copy prompt</span>
        </button>
      </div>
      <div class="llm-prompt-preview">
        {promptLines.map((line) => <p>{line}</p>)}
      </div>
      <div class="llm-prompt-caret llm-prompt-caret-collapsed">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          width="16"
          height="16"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="m19.5 8.25-7.5 7.5-7.5-7.5"></path>
        </svg>
      </div>
    </summary>
    <div class="llm-prompt-body">
      {promptLines.map((line) => <p>{line}</p>)}
      <div class="llm-prompt-caret llm-prompt-caret-expanded">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          width="16"
          height="16"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="m19.5 8.25-7.5 7.5-7.5-7.5"></path>
        </svg>
      </div>
    </div>
  </details>
  <script
    type="application/json"
    id={id}
    set:html={JSON.stringify(finalPrompt)}
  />
</llm-copy-prompt>

<style>
  .llm-prompt-card {
    border: 1px solid var(--sl-color-hairline);
    border-radius: 0.75rem;
    background: var(--sl-color-gray-6);
    margin-bottom: 1.5rem;
  }

  .llm-prompt-card > summary {
    list-style: none;
    list-style-type: none;
    cursor: pointer;
    padding: 1rem 1.25rem;
  }

  .llm-prompt-card > summary::-webkit-details-marker {
    display: none;
  }

  .llm-prompt-card > summary::marker {
    display: none;
    content: '';
    font-size: 0;
  }

  .llm-prompt-card > summary::before {
    display: none;
    content: none;
  }

  .llm-prompt-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .llm-prompt-icon {
    color: var(--sl-color-text-accent);
    flex-shrink: 0;
    display: flex;
  }

  .llm-prompt-title {
    font-weight: 600;
    color: var(--sl-color-white);
    flex: 1;
  }

  .llm-copy-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: var(--sl-text-xs);
    color: var(--sl-color-gray-3);
    background: none;
    border: 1px solid var(--sl-color-hairline);
    border-radius: 0.375rem;
    padding: 0.25rem 0.625rem;
    cursor: pointer;
    transition:
      color 0.2s,
      border-color 0.2s;
    white-space: nowrap;
  }

  .llm-copy-btn:hover {
    color: var(--sl-color-white);
    border-color: var(--sl-color-gray-3);
  }

  .llm-copy-btn svg {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    margin: 0;
  }

  .llm-copy-btn .icon-copied {
    display: none;
  }

  .llm-copy-btn.copied .icon-default {
    display: none;
  }

  .llm-copy-btn.copied .icon-copied {
    display: block;
  }

  .llm-prompt-preview {
    position: relative;
    margin-top: 0.5rem;
    color: var(--sl-color-gray-3);
    font-size: var(--sl-text-sm);
    line-height: 1.5;
    max-height: 3em;
    overflow: hidden;
    -webkit-mask-image: linear-gradient(to bottom, #000 40%, transparent 100%);
    mask-image: linear-gradient(to bottom, #000 40%, transparent 100%);
  }

  .llm-prompt-preview :global(p) {
    margin: 0;
  }

  .llm-prompt-preview :global(ol),
  .llm-prompt-preview :global(ul) {
    margin: 0;
    padding-left: 1.25rem;
  }

  .llm-prompt-caret {
    color: var(--sl-color-gray-4);
  }

  .llm-prompt-caret-collapsed {
    display: flex;
    justify-content: center;
    margin-top: 0.5rem;
  }

  .llm-prompt-caret-expanded {
    display: flex;
    justify-content: center;
    margin-top: 0.75rem;
    cursor: pointer;
  }

  .llm-prompt-caret-expanded svg {
    transform: rotateZ(180deg);
  }

  .llm-prompt-card[open] .llm-prompt-caret-collapsed {
    display: none;
  }

  .llm-prompt-card[open] .llm-prompt-preview {
    display: none;
  }

  .llm-prompt-body {
    padding: 0 1.25rem 1rem;
    color: var(--sl-color-gray-2);
    font-size: var(--sl-text-sm);
    line-height: 1.6;
  }

  .llm-prompt-body :global(p) {
    margin: 0 0 0.5rem;
  }

  .llm-prompt-body :global(ol),
  .llm-prompt-body :global(ul) {
    margin: 0 0 0.5rem;
    padding-left: 1.25rem;
  }

  .llm-prompt-body :global(li) {
    margin-bottom: 0.125rem;
  }
</style>

<script>
  class LlmCopyPromptElement extends HTMLElement {
    private button: HTMLButtonElement | null = null;
    private collapseCaret: HTMLElement | null = null;
    private details: HTMLDetailsElement | null = null;
    private timeout: number | null = null;
    private content: string | null = null;

    constructor() {
      super();
      this.button = this.querySelector('.llm-copy-btn');
      this.collapseCaret = this.querySelector('.llm-prompt-caret-expanded');
      this.details = this.querySelector('details');

      const contentId = this.dataset.contentId;
      if (contentId) {
        const scriptTag = this.querySelector(`#${contentId}`);
        if (scriptTag?.textContent) {
          try {
            this.content = JSON.parse(scriptTag.textContent);
          } catch (e) {
            console.error('Failed to parse prompt content:', e);
          }
        }
      }
    }

    connectedCallback() {
      this.button?.addEventListener('click', this.handleClick);
      this.collapseCaret?.addEventListener('click', this.handleCollapse);
    }

    disconnectedCallback() {
      this.button?.removeEventListener('click', this.handleClick);
      this.collapseCaret?.removeEventListener('click', this.handleCollapse);
      if (this.timeout) {
        clearTimeout(this.timeout);
      }
    }

    private handleCollapse = () => {
      if (this.details) this.details.open = false;
    };

    private handleClick = async (e: Event) => {
      e.preventDefault();
      e.stopPropagation();
      if (!this.content) return;

      try {
        await navigator.clipboard.writeText(this.content);
        this.showCopiedState();
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    };

    private showCopiedState() {
      this.button?.classList.add('copied');
      const label = this.button?.querySelector('.copy-label');
      if (label) label.textContent = 'Copied!';

      if (this.timeout) {
        clearTimeout(this.timeout);
      }

      this.timeout = window.setTimeout(() => {
        this.button?.classList.remove('copied');
        if (label) label.textContent = 'Copy prompt';
      }, 3000);
    }
  }

  customElements.define('llm-copy-prompt', LlmCopyPromptElement);
</script>
