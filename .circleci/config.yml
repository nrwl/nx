version: 2.1

executors:
  docker-bench:
    docker:
      - image: cimg/base:stable
    resource_class: large
    working_directory: ~/repo

jobs:
  docker-bench-no-cache:
    executor: docker-bench
    parameters:
      filler_mb:
        type: integer
        default: 4096
    steps:
      - checkout
      - setup_remote_docker:
          version: 24.0.5
      - run:
          name: Build image (no cache, no push)
          command: |
            START=$(date +%s)
            docker buildx build \
              --builder default \
              --progress=plain \
              --load \
              -f docker/benchmarks/cache-stress.Dockerfile \
              --build-arg FILLER_MB=<< parameters.filler_mb >> \
              -t cachebench:no-cache-${CIRCLE_SHA1} \
              docker/benchmarks
            END=$(date +%s)
            echo "build_seconds=$((END-START))"

  docker-bench-cache-from:
    executor: docker-bench
    parameters:
      filler_mb:
        type: integer
        default: 4096
      cache_ref:
        type: string
        default: "volkeron/docker-cache-bench:cache"
    steps:
      - checkout
      - setup_remote_docker:
          version: 24.0.5
      - run:
          name: Build using registry cache (read-only)
          command: |
            START=$(date +%s)
            docker buildx build \
              --builder default \
              --progress=plain \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              --cache-from=type=registry,ref=<< parameters.cache_ref >> \
              --load \
              -f docker/benchmarks/cache-stress.Dockerfile \
              --build-arg FILLER_MB=<< parameters.filler_mb >> \
              -t cachebench:remote-cache-${CIRCLE_SHA1} \
              docker/benchmarks
            END=$(date +%s)
            echo "build_seconds=$((END-START))"

  docker-bench-dlc:
    executor: docker-bench
    parameters:
      filler_mb:
        type: integer
        default: 4096
    steps:
      - checkout
      - setup_remote_docker:
          version: 24.0.5
          docker_layer_caching: true
      - run:
          name: Build leveraging DLC (no push)
          command: |
            START=$(date +%s)
            docker buildx build \
              --builder default \
              --progress=plain \
              --load \
              -f docker/benchmarks/cache-stress.Dockerfile \
              --build-arg FILLER_MB=<< parameters.filler_mb >> \
              -t cachebench:dlc-${CIRCLE_SHA1} \
              docker/benchmarks
            END=$(date +%s)
            echo "build_seconds=$((END-START))"

workflows:
  version: 2

  docker-benchmarks:
    jobs:
      - docker-bench-no-cache
      - docker-bench-cache-from
      - docker-bench-dlc
